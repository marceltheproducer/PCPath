#!/bin/bash
# postinstall â€” runs as root after pkg installs files to /usr/local/pcpath
# Sets permissions and installs the LaunchAgent for per-user setup.

SYSTEM_DIR="/usr/local/pcpath"
LAUNCH_AGENT_SRC="$SYSTEM_DIR/com.pcpath.user-setup.plist"
LAUNCH_AGENT_DST="/Library/LaunchAgents/com.pcpath.user-setup.plist"

# Make scripts executable
chmod +x "$SYSTEM_DIR/pcpath_common.sh"
chmod +x "$SYSTEM_DIR/copy_pc_path.sh"
chmod +x "$SYSTEM_DIR/paste_mac_path.sh"
chmod +x "$SYSTEM_DIR/user_setup.sh"

# Install LaunchAgent system-wide (runs per user at login)
cp "$LAUNCH_AGENT_SRC" "$LAUNCH_AGENT_DST"
chmod 644 "$LAUNCH_AGENT_DST"
chown root:wheel "$LAUNCH_AGENT_DST"

# Run user_setup now for any currently logged-in user
CONSOLE_USER=$(stat -f "%Su" /dev/console 2>/dev/null)
if [[ -n "$CONSOLE_USER" && "$CONSOLE_USER" != "root" ]]; then
    CONSOLE_UID=$(id -u "$CONSOLE_USER")
    launchctl asuser "$CONSOLE_UID" sudo -u "$CONSOLE_USER" /bin/bash "$SYSTEM_DIR/user_setup.sh"
fi

exit 0
